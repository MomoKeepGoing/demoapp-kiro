# 实施计划

## 任务列表

- [x] 1. 初始化项目和配置Amplify Gen2
  - 创建React + TypeScript项目
  - 安装Amplify依赖包（@aws-amplify/backend, aws-amplify, @aws-amplify/ui-react）
  - 初始化Amplify Gen2配置
  - _需求: 所有需求的基础_

- [x] 2. 配置后端身份验证资源
  - 创建 `amplify/auth/resource.ts` 文件
  - 配置邮箱登录和验证码验证
  - 配置用户属性（username, profilePicture）
  - 配置密码策略和账户恢复
  - _需求: 1.1, 1.3, 1.4, 1.5, 1.6, 1.7_

- [x] 3. 配置后端数据资源
  - 创建 `amplify/data/resource.ts` 文件
  - 定义UserProfile数据模型
  - 配置owner-based授权规则
  - 设置userPool授权模式
  - _需求: 3.1, 3.2, 5.1, 5.2_

- [x] 4. 配置后端存储资源
  - 创建 `amplify/storage/resource.ts` 文件
  - 配置S3存储桶
  - 设置文件路径访问规则（entity-based）
  - _需求: 3.3, 5.3, 5.4_

- [x] 5. 配置后端资源集成
  - 创建 `amplify/backend.ts` 文件
  - 集成auth、data和storage资源
  - _需求: 所有需求的基础_

- [x] 6. 部署到Amplify沙箱环境
  - 运行 `npx ampx sandbox` 启动沙箱
  - 验证后端资源部署成功
  - 检查生成的 `amplify_outputs.json` 文件
  - 测试Auth、Data和Storage资源可访问性
  - 验证授权规则配置正确
  - _需求: 所有需求的基础_

- [x] 7. 实现前端Amplify配置
  - 在 `src/main.tsx` 中配置Amplify
  - 导入 `amplify_outputs.json`
  - 设置Amplify客户端
  - _需求: 所有需求的基础_

- [x] 8. 实现用户注册和登录功能
  - 使用Amplify UI的Authenticator组件
  - 自定义Authenticator样式（WhatsApp风格）
  - 实现注册表单和验证码输入
  - 实现登录状态管理和登出功能
  - 处理各种错误情况（重复邮箱、验证码错误、未激活账户等）
  - _需求: 1.1-1.7, 2.1-2.5_

- [ ]* 8.1 编写属性测试：注册和登录
  - **属性 1: 有效注册创建账户** (需求: 1.1)
  - **属性 2: 无效密码被拒绝** (需求: 1.3)
  - **属性 3: 正确验证码激活账户** (需求: 1.5)
  - **属性 4: 错误验证码被拒绝** (需求: 1.6)
  - **属性 5: 正确凭证授予访问** (需求: 2.1)
  - **属性 6: 错误凭证被拒绝** (需求: 2.2)
  - **属性 7: 会话保持直到登出** (需求: 2.4)

- [ ]* 8.2 编写单元测试：边界情况
  - 测试重复邮箱注册
  - 测试验证码过期
  - 测试未激活账户登录
  - 测试会话过期

- [x] 9. 实现个人资料功能
  - 创建Profile页面组件
  - 实现用户资料数据加载和显示
  - 实现用户名编辑功能（含验证）
  - 实现头像上传功能（含文件验证）
  - 实现上传进度显示
  - 处理验证错误和授权错误
  - _需求: 3.1-3.6_

- [ ]* 9.1 编写属性测试：资料管理
  - **属性 8: 资料显示正确内容** (需求: 3.1)
  - **属性 9: 用户名更新往返一致性** (需求: 3.2)
  - **属性 10: 头像上传往返一致性** (需求: 3.3)
  - **属性 11: 空白用户名被拒绝** (需求: 3.4)
  - **属性 12: 非图片文件被拒绝** (需求: 3.6)

- [ ]* 9.2 编写单元测试：文件上传边界情况
  - 测试文件大小边界（恰好5MB）
  - 测试各种图片格式

- [x] 10. 实现数据授权验证
  - 验证用户只能访问和修改自己的资料
  - 验证用户只能访问自己的头像
  - 实现授权错误的友好提示
  - _需求: 5.1-5.4_

- [ ]* 10.1 编写属性测试：授权控制
  - **属性 13: 用户只能访问自己的资料** (需求: 5.1, 5.2)
  - **属性 14: 用户只能访问自己的头像** (需求: 5.3, 5.4)

- [x] 11. 实现UI和用户体验
  - 创建全局样式配置（WhatsApp风格）
  - 实现响应式布局（移动端和桌面端）
  - 自定义Authenticator组件样式
  - 实现Profile页面样式和交互动画
  - 创建错误处理和Toast通知组件
  - 实现加载状态和表单验证反馈
  - _需求: 4.1-4.4, 所有需求_

- [x] 12. 性能优化和测试配置
  - 实现图片压缩（上传前）
  - 配置代码分割和组件懒加载
  - 安装并配置fast-check属性测试框架
  - 创建测试工具函数和数据生成器
  - 配置每个属性测试运行100次迭代
  - _需求: 所有需求_

- [x] 13. 检查点 - 验证核心功能
  - 确保所有核心功能正常工作
  - 运行已有的属性测试
  - 如有问题请询问用户

- [ ]* 14. 编写集成和E2E测试
  - 测试完整注册流程（注册→验证→登录）
  - 测试完整资料更新流程（登录→更新用户名→上传头像）
  - 测试授权流程（多用户访问隔离）
  - 配置Cypress或Playwright进行E2E测试
  - _需求: 所有需求_

- [ ]* 15. 部署和监控配置
  - 配置生产环境变量
  - 连接Git仓库到Amplify Hosting
  - 配置CI/CD流程并部署到main分支
  - 配置CloudWatch日志和关键指标监控
  - 设置告警规则
  - _需求: 所有需求_

- [ ]* 16. 编写项目文档
  - 编写README.md（项目介绍、安装和运行）
  - 编写部署指南
  - 编写API使用文档
  - _需求: 所有需求_

- [ ]* 17. 最终验证
  - 验证生产环境功能
  - 确保所有测试通过
  - 如有问题请询问用户

## 任务说明

### 可选任务标记
带有 `*` 后缀的任务为可选任务，主要包括测试和文档相关的任务。这些任务对于确保代码质量很重要，但不是核心功能实现的必需部分。

### 属性测试要求
- 使用 `fast-check` 库
- 每个属性测试至少运行100次迭代
- 必须使用注释标记对应的设计文档属性：`// **Feature: amplify-im-app, Property X: 属性名称**`

### 实施顺序
1. 首先完成后端资源配置和沙箱部署（任务1-6）
2. 然后实现核心功能（任务7-10）
3. 接着完善UI、性能和测试（任务11-13）
4. 最后进行部署、监控和文档（任务14-17）

### 依赖关系
- 任务7-17依赖任务1-6完成（后端资源和沙箱部署）
- 任务9-10依赖任务8完成（认证功能）
- 任务12必须在编写属性测试前完成
- 任务13和17是检查点，确保代码质量
- 任务15（生产部署）依赖所有核心功能完成

### 测试策略
- 单元测试：验证特定功能和边界情况
- 属性测试：验证通用正确性属性
- 集成测试：验证多组件交互
- E2E测试：验证完整用户流程

### 任务合并说明
为了提高效率，我们将相关任务进行了合并：
- 任务8合并了注册和登录功能
- 任务9合并了所有个人资料相关功能
- 任务11合并了UI和用户体验相关功能
- 任务12合并了性能优化和测试配置
- 任务15合并了部署和监控配置
