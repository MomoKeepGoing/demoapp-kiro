# 需求文档

## 简介

本文档定义了LinkUp即时通讯应用中一对一消息功能的需求。该功能允许用户与联系人进行实时文本消息交流，包括发送消息、接收消息、查看消息历史等核心即时通讯能力。

## 术语表

- **消息系统**: LinkUp应用中负责消息发送、接收、存储和展示的子系统
- **用户**: 已注册并通过邮箱验证的应用使用者
- **联系人**: 用户已添加的其他用户
- **对话**: 两个用户之间的消息交流会话
- **消息**: 用户发送的文本内容，包含发送者、接收者、内容、时间戳等信息
- **消息历史**: 对话中所有历史消息的记录
- **实时消息**: 通过WebSocket或订阅机制即时推送的新消息
- **Message**: 表示单条消息的数据模型
- **Conversation**: 表示对话的数据模型

## 需求

### 需求 1: 发送文本消息

**用户故事:** 作为用户，我想向我的联系人发送文本消息，以便我可以与他们进行交流。

#### 验收标准

1. WHEN 用户输入消息内容并点击发送按钮 THEN 消息系统 SHALL 创建消息记录并发送给接收者
2. WHEN 用户输入的消息内容为空或仅包含空白字符 THEN 消息系统 SHALL 拒绝发送并保持输入框状态
3. WHEN 用户输入的消息内容超过5000个字符 THEN 消息系统 SHALL 拒绝发送并显示字符限制提示
4. WHEN 消息发送成功 THEN 消息系统 SHALL 在对话界面中显示该消息
5. WHEN 消息发送成功 THEN 消息系统 SHALL 清空输入框并保持输入框焦点
6. WHEN 消息发送失败 THEN 消息系统 SHALL 显示错误提示并保留输入框内容
7. WHEN 消息发送中 THEN 消息系统 SHALL 显示发送状态指示器

### 需求 2: 接收文本消息

**用户故事:** 作为用户，我想实时接收其他用户发送给我的消息，以便我可以及时回复。

#### 验收标准

1. WHEN 其他用户发送消息给用户 THEN 消息系统 SHALL 实时推送消息到用户的对话界面
2. WHEN 用户正在查看对话 THEN 消息系统 SHALL 立即在对话界面中显示新消息
3. WHEN 用户未查看对话 THEN 消息系统 SHALL 在对话列表中显示未读消息提示
4. WHEN 用户正在查看对话并接收新消息 THEN 消息系统 SHALL 自动将消息标记为已读
5. WHEN 用户未查看对话并接收新消息 THEN 消息系统 SHALL 将消息标记为未读
6. WHEN 接收到新消息 THEN 消息系统 SHALL 记录消息的接收时间戳
7. WHEN 接收到新消息 THEN 消息系统 SHALL 将消息存储到数据库

### 需求 3: 消息历史查看

**用户故事:** 作为用户，我想查看与联系人的历史消息记录，以便我可以回顾之前的对话内容。

#### 验收标准

1. WHEN 用户打开与联系人的对话 THEN 消息系统 SHALL 加载并显示最近的消息历史
2. WHEN 消息历史超过50条 THEN 消息系统 SHALL 仅加载最近50条消息
3. WHEN 用户滚动到对话顶部 THEN 消息系统 SHALL 加载更早的消息记录
4. WHEN 显示消息 THEN 消息系统 SHALL 按时间顺序从旧到新排列
5. WHEN 显示消息 THEN 消息系统 SHALL 区分发送者和接收者的消息
6. WHEN 显示消息 THEN 消息系统 SHALL 显示每条消息的发送时间
7. WHEN 消息历史为空 THEN 消息系统 SHALL 显示空状态提示

### 需求 4: 对话列表管理

**用户故事:** 作为用户，我想查看所有对话列表，以便我可以快速切换到不同的对话。

#### 验收标准

1. WHEN 用户访问消息页面 THEN 消息系统 SHALL 显示所有对话列表
2. WHEN 显示对话列表 THEN 消息系统 SHALL 按最后消息时间倒序排列
3. WHEN 显示对话项 THEN 消息系统 SHALL 包含联系人头像、用户名、最后消息预览和时间
4. WHEN 对话有未读消息 THEN 消息系统 SHALL 显示未读消息数量标记
5. WHEN 对话列表为空 THEN 消息系统 SHALL 显示空状态提示
6. WHEN 用户点击对话项 THEN 消息系统 SHALL 打开该对话的消息界面

### 需求 5: 消息状态显示

**用户故事:** 作为用户，我想知道我发送的消息状态，以便我可以确认消息是否成功送达。

#### 验收标准

1. WHEN 消息正在发送 THEN 消息系统 SHALL 显示发送中状态图标
2. WHEN 消息发送成功 THEN 消息系统 SHALL 显示已发送状态图标
3. WHEN 消息发送失败 THEN 消息系统 SHALL 显示失败状态图标
4. WHEN 用户点击失败消息 THEN 消息系统 SHALL 提供重新发送选项

### 需求 6: 数据授权

**用户故事:** 作为用户，我想确保我的消息数据安全，以便只有对话参与者可以访问消息内容。

#### 验收标准

1. WHEN 用户访问对话 THEN 消息系统 SHALL 仅允许对话参与者访问消息内容
2. WHEN 用户尝试访问非参与者的对话 THEN 消息系统 SHALL 拒绝访问并返回授权错误
3. WHEN 用户发送消息给联系人 THEN 消息系统 SHALL 允许发送
4. WHEN 用户发送消息给非联系人 THEN 消息系统 SHALL 允许发送
5. WHEN 用户接收来自联系人的消息 THEN 消息系统 SHALL 接收并显示消息
6. WHEN 用户接收来自非联系人的消息 THEN 消息系统 SHALL 接收并显示消息

### 需求 7: 用户界面设计

**用户故事:** 作为用户，我想要一个直观的消息界面，以便我可以轻松地发送和查看消息。

#### 验收标准

1. WHEN 用户使用消息功能 THEN 消息系统 SHALL 提供类似WhatsApp的对话界面布局
2. WHEN 显示消息 THEN 消息系统 SHALL 使用气泡样式区分发送和接收的消息
3. WHEN 用户输入消息 THEN 消息系统 SHALL 提供固定在底部的输入框
4. WHEN 用户与界面交互 THEN 消息系统 SHALL 提供即时的视觉反馈
5. WHEN 应用在移动设备上运行 THEN 消息系统 SHALL 提供响应式布局适配不同屏幕尺寸
6. WHEN 数据加载中 THEN 消息系统 SHALL 显示加载指示器

### 需求 8: 消息输入体验

**用户故事:** 作为用户，我想要流畅的消息输入体验，以便我可以高效地编写和发送消息。

#### 验收标准

1. WHEN 用户按下Enter键 THEN 消息系统 SHALL 发送消息
2. WHEN 用户按下Shift+Enter键 THEN 消息系统 SHALL 在消息中插入换行符
3. WHEN 用户输入多行文本 THEN 消息系统 SHALL 自动调整输入框高度
4. WHEN 输入框高度超过4行 THEN 消息系统 SHALL 固定高度并启用滚动
5. WHEN 消息发送后 THEN 消息系统 SHALL 重置输入框高度为初始状态

### 需求 9: 消息时间显示

**用户故事:** 作为用户，我想清楚地看到消息的发送时间，以便我可以了解对话的时间线。

#### 验收标准

1. WHEN 显示消息 THEN 消息系统 SHALL 在每条消息旁显示时间戳
2. WHEN 消息是今天发送的 THEN 消息系统 SHALL 仅显示时间（如"14:30"）
3. WHEN 消息是昨天发送的 THEN 消息系统 SHALL 显示"昨天"和时间
4. WHEN 消息是更早发送的 THEN 消息系统 SHALL 显示完整日期和时间
5. WHEN 连续消息时间间隔小于5分钟 THEN 消息系统 SHALL 仅在第一条消息显示时间

### 需求 10: 非联系人消息处理

**用户故事:** 作为用户，我想接收来自非联系人的消息，以便我可以与新用户建立联系。

#### 验收标准

1. WHEN 用户接收来自非联系人的消息 THEN 消息系统 SHALL 在对话列表中创建新对话
2. WHEN 显示非联系人对话 THEN 消息系统 SHALL 标记该用户为非联系人状态
3. WHEN 用户查看非联系人对话 THEN 消息系统 SHALL 提供添加为联系人的选项
4. WHEN 用户向非联系人发送消息 THEN 消息系统 SHALL 允许发送并创建对话
5. WHEN 用户将非联系人添加为联系人 THEN 消息系统 SHALL 更新对话状态为联系人对话

### 需求 11: 离线消息和未读管理

**用户故事:** 作为用户，我想在上线后查看离线期间收到的消息，以便我不会错过任何重要信息。

#### 验收标准

1. WHEN 用户离线时接收到消息 THEN 消息系统 SHALL 存储消息到数据库
2. WHEN 用户重新上线 THEN 消息系统 SHALL 加载所有离线期间的未读消息
3. WHEN 用户打开对话 THEN 消息系统 SHALL 显示该对话的所有未读消息
4. WHEN 用户查看对话 THEN 消息系统 SHALL 将该对话的消息标记为已读
5. WHEN 对话有未读消息 THEN 消息系统 SHALL 在对话列表中显示未读消息数量
6. WHEN 用户有未读消息 THEN 消息系统 SHALL 在应用图标或标题栏显示总未读数量


