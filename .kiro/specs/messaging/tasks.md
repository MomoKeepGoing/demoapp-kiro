# 实现计划

- [x] 1. 设置数据模型和后端配置
  - ✅ 在 `amplify/data/resource.ts` 中定义 Message 和 Conversation 数据模型
  - ✅ 配置授权规则（owner-based authorization）
  - ✅ 配置 GSI（Global Secondary Index）用于高效查询
    - Message: bySender, byReceiver, byConversation
    - Conversation: byUser
  - ⏳ 部署并验证 GraphQL API 生成成功（需要运行 `npx ampx sandbox`）
  - _需求: 1.1, 2.1, 6.1, 6.2_
  - _完成时间: 2024-12-04_

- [ ]* 1.1 编写属性测试验证数据模型
  - **属性 1: 消息创建完整性**
  - **验证需求: 1.1**

- [x] 2. 实现消息 API 工具函数
  - 创建 `src/utils/messageApi.ts` 文件
  - 实现 `sendMessage` 函数（发送消息并更新对话）
  - 实现 `listConversations` 函数（获取对话列表）
  - 实现 `listMessages` 函数（获取消息历史，支持分页）
  - 实现 `markConversationAsRead` 函数（批量标记已读）
  - 实现 `subscribeToMessages` 函数（订阅新消息）
  - 实现 `getOrCreateConversation` 函数（获取或创建对话）
  - _需求: 1.1, 2.1, 3.1, 4.1, 11.4_

- [ ]* 2.1 编写属性测试验证消息发送
  - **属性 1: 消息创建完整性**
  - **属性 2: 空白内容拒绝**
  - **验证需求: 1.1, 1.2**

- [ ]* 2.2 编写属性测试验证消息持久化
  - **属性 7: 消息持久化**
  - **验证需求: 2.7**

- [x] 3. 实现工具函数
  - 创建 `src/utils/messageHelpers.ts` 文件
  - 实现 `formatMessageTime` 函数（时间格式化：今天/昨天/完整日期）
  - 实现 `validateMessageContent` 函数（验证消息内容）
  - 实现 `generateConversationId` 函数（生成对话ID）
  - 实现 `calculateUnreadCount` 函数（计算未读数量）
  - 实现 `shouldShowTimestamp` 函数（判断是否显示时间戳）
  - _需求: 1.2, 1.3, 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ]* 3.1 编写属性测试验证时间格式化
  - **属性 16: 时间格式化 - 今天**
  - **属性 17: 时间格式化 - 昨天**
  - **属性 18: 时间格式化 - 更早**
  - **验证需求: 9.2, 9.3, 9.4**

- [ ]* 3.2 编写属性测试验证内容验证
  - **属性 2: 空白内容拒绝**
  - **验证需求: 1.2**

- [x] 4. 实现 MessageBubble 组件
  - 创建 `src/components/messages/MessageBubble.tsx` 和对应的 CSS 文件
  - 显示消息内容（支持多行文本）
  - 显示时间戳（使用 formatMessageTime）
  - 显示消息状态图标（发送中/已发送/失败）
  - 区分发送和接收消息的样式（WhatsApp 风格）
  - 支持点击失败消息重试
  - _需求: 3.5, 3.6, 5.1, 5.2, 5.3, 5.4, 9.1_

- [ ]* 4.1 编写单元测试验证 MessageBubble
  - 测试消息内容显示
  - 测试时间格式化
  - 测试状态图标显示
  - 测试发送/接收样式区分

- [x] 5. 实现 ConversationListItem 组件
  - 创建 `src/components/messages/ConversationListItem.tsx` 和对应的 CSS 文件
  - 显示对方用户头像（使用 Storage API 获取）
  - 显示对方用户名
  - 显示最后消息预览（截断到100字符）
  - 显示最后消息时间（使用 formatMessageTime）
  - 显示未读消息数量标记（红色圆点）
  - 支持点击事件
  - _需求: 4.3, 4.4_

- [ ]* 5.1 编写属性测试验证对话信息完整性
  - **属性 11: 对话信息完整性**
  - **验证需求: 4.3**

- [ ]* 5.2 编写属性测试验证未读数量显示
  - **属性 12: 未读数量显示**
  - **验证需求: 4.4**

- [x] 6. 实现 ConversationView 组件
  - 创建 `src/components/messages/ConversationView.tsx` 和对应的 CSS 文件
  - 显示对话标题（对方用户名和头像）
  - 实现消息列表（使用 MessageBubble 组件）
  - 实现自动滚动到最新消息
  - 实现无限滚动加载历史消息
  - 实现固定在底部的输入框
  - 实现发送按钮（Enter 发送，Shift+Enter 换行）
  - 实现输入框自动高度调整（最多4行）
  - 订阅新消息并实时显示
  - 打开对话时自动标记为已读
  - 显示加载状态和空状态
  - _需求: 1.1, 1.4, 1.5, 2.2, 3.1, 3.3, 3.7, 8.1, 8.2, 8.3, 8.4, 8.5, 11.4_

- [ ]* 6.1 编写属性测试验证消息排序
  - **属性 8: 消息历史排序**
  - **验证需求: 3.4**

- [ ]* 6.2 编写属性测试验证自动已读标记
  - **属性 4: 自动已读标记**
  - **验证需求: 2.4**

- [ ]* 6.3 编写单元测试验证 ConversationView
  - 测试消息列表渲染
  - 测试输入框交互
  - 测试发送消息流程
  - 测试键盘事件处理

- [x] 7. 实现 MessagesPage 组件
  - 创建 `src/components/messages/MessagesPage.tsx` 和对应的 CSS 文件
  - 显示对话列表（使用 ConversationListItem 组件）
  - 实现对话列表排序（按 lastMessageAt 降序）
  - 显示总未读消息数量（在标题栏）
  - 订阅新消息更新对话列表
  - 点击对话打开 ConversationView
  - 显示加载状态和空状态
  - 实现搜索栏（可选，用于搜索对话）
  - _需求: 4.1, 4.2, 4.5, 4.6, 11.5, 11.6_

- [ ]* 7.1 编写属性测试验证对话列表排序
  - **属性 10: 对话列表排序**
  - **验证需求: 4.2**

- [ ]* 7.2 编写单元测试验证 MessagesPage
  - 测试对话列表渲染
  - 测试空状态显示
  - 测试对话点击导航

- [x] 8. 实现非联系人消息处理
  - 在 ConversationView 中检测非联系人状态
  - 显示"添加为联系人"按钮（对于非联系人对话）
  - 实现添加联系人功能（调用 contactApi）
  - 添加成功后更新对话状态
  - 在 ConversationListItem 中显示非联系人标记
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ]* 8.1 编写属性测试验证非联系人对话创建
  - **属性 19: 非联系人对话创建**
  - **验证需求: 10.1**

- [ ]* 8.2 编写属性测试验证跨联系人状态消息
  - **属性 14: 跨联系人状态发送**
  - **属性 15: 跨联系人状态接收**
  - **验证需求: 6.3, 6.4, 6.5, 6.6**

- [x] 9. 实现离线消息处理
  - 在 MessagesPage 加载时获取所有对话（包含未读数）
  - 在 ConversationView 打开时加载所有消息（包括离线消息）
  - 实现 markConversationAsRead 的批量更新逻辑
  - 优化批量更新性能（异步执行）
  - 在对话列表显示未读数量
  - 在应用标题栏显示总未读数量
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_

- [ ]* 9.1 编写属性测试验证离线消息
  - **属性 20: 离线消息存储**
  - **属性 21: 离线消息加载**
  - **属性 22: 查看标记已读**
  - **验证需求: 11.1, 11.2, 11.4**

- [x] 10. 集成到主应用
  - 在 `src/App.tsx` 中添加消息页面路由
  - 创建导航菜单项（联系人 / 消息）
  - 在主应用中显示总未读消息数量（红点提示）
  - 确保认证状态正确传递
  - 测试页面切换和状态保持
  - _需求: 4.1, 11.6_

- [x] 11. 错误处理和用户体验优化
  - 实现网络错误处理（显示 Toast 提示）
  - 实现授权错误处理（友好提示并返回）
  - 实现 Subscription 重连机制（指数退避）
  - 实现乐观更新（发送消息立即显示）
  - 实现消息发送失败重试
  - 添加加载骨架屏
  - 优化滚动性能（虚拟滚动，可选）
  - _需求: 1.6, 1.7, 5.4, 7.6_

- [ ]* 11.1 编写单元测试验证错误处理
  - 测试网络错误场景
  - 测试授权错误场景
  - 测试重试机制

- [x] 12. 样式和响应式设计
  - 实现 WhatsApp 风格的 UI 设计
  - 实现消息气泡样式（发送/接收不同颜色）
  - 实现响应式布局（移动端适配）
  - 优化触摸交互（移动端）
  - 添加动画效果（消息进入、滚动）
  - 确保无障碍访问（ARIA 标签）
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 13. 开发环境部署和验证
  - 启动 Amplify sandbox 环境（`npx ampx sandbox`）
  - 验证 GraphQL API 部署成功
  - 在 AppSync 控制台测试 mutations 和 queries
  - 验证 DynamoDB 表创建成功（Message 和 Conversation）
  - 验证 GSI 索引配置正确
  - 测试授权规则（尝试访问其他用户的数据）
  - 启动前端开发服务器（`npm run dev`）
  - 进行端到端功能测试
  - _需求: 所有需求_

- [x] 13.1 端到端功能测试
  - 测试用户 A 发送消息给用户 B
  - 测试用户 B 实时接收消息
  - 测试离线消息（用户 B 离线，用户 A 发送，用户 B 上线后查看）
  - 测试未读消息数量显示
  - 测试标记已读功能
  - 测试非联系人消息（用户 C 向用户 A 发送消息）
  - 测试消息历史分页加载
  - 测试对话列表排序
  - 测试错误处理（网络断开、重连）
  - 记录测试结果和发现的问题

- [x] 14. 最终检查点 - 确保所有测试通过
  - 确保所有单元测试通过
  - 确保所有属性测试通过
  - 确保端到端测试通过
  - 如有问题请询问用户
