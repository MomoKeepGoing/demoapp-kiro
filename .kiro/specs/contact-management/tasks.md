# 实施计划

## 任务列表

- [x] 1. 扩展后端数据模型
  - 更新 `amplify/data/resource.ts` 添加Contact模型
  - 更新UserProfile模型的授权规则，允许已认证用户读取
  - 配置Contact模型的复合主键（userId + contactUserId）
  - 配置owner-based授权规则
  - _需求: 2.1, 5.1, 5.2, 5.3, 5.4_

- [x] 2. 部署和验证后端更新
  - 运行 `npx ampx sandbox` 部署更新
  - 验证Contact模型创建成功
  - 测试UserProfile的读取权限
  - 验证授权规则配置正确
  - _需求: 所有需求的基础_

- [x] 3. 实现联系人API工具函数
  - 创建 `src/utils/contactApi.ts` 文件
  - 实现searchUsers函数（搜索用户）
  - 实现createContact函数（添加联系人）
  - 实现listContacts函数（查询联系人列表）
  - 实现deleteContact函数（删除联系人）
  - 实现isContact函数（检查是否已是联系人）
  - 添加错误处理和类型定义
  - _需求: 1.1-1.7, 2.1-2.5, 3.1-3.5, 4.2-4.4_

- [ ]* 3.1 编写属性测试：搜索功能
  - **属性 1: 搜索返回匹配结果** (需求: 1.1, 1.2, 1.3)
  - **属性 2: 搜索结果限制20条** (需求: 1.5)
  - **属性 3: 搜索结果排除当前用户** (需求: 1.6)

- [ ]* 3.2 编写属性测试：联系人管理
  - **属性 5: 添加联系人创建记录** (需求: 2.1)
  - **属性 6: 重复添加被拒绝** (需求: 2.2)
  - **属性 8: 联系人记录包含时间戳** (需求: 2.5)
  - **属性 9: 联系人列表完整性** (需求: 3.1)
  - **属性 10: 联系人信息完整性** (需求: 3.3)
  - **属性 11: 联系人列表按时间倒序** (需求: 3.4)
  - **属性 12: 删除联系人移除记录** (需求: 4.2, 4.3)

- [ ]* 3.3 编写属性测试：授权控制
  - **属性 14: 用户只能访问自己的联系人** (需求: 5.1, 5.2)
  - **属性 15: 用户只能为自己添加联系人** (需求: 5.3)
  - **属性 16: 用户只能删除自己的联系人** (需求: 5.4)

- [x] 4. 实现搜索栏组件
  - 创建 `src/components/contacts/SearchBar.tsx`
  - 实现搜索输入框UI
  - 实现防抖处理（300ms延迟）
  - 实现加载状态显示
  - 添加WhatsApp风格样式
  - _需求: 1.1-1.7, 6.1, 6.3, 6.6, 7.2, 7.3_

- [ ]* 4.1 编写属性测试：防抖机制
  - **属性 17: 防抖机制减少请求** (需求: 7.2, 7.3)

- [x] 5. 实现用户卡片组件
  - 创建 `src/components/contacts/UserCard.tsx`
  - 显示用户头像、用户名和邮箱
  - 实现添加联系人按钮
  - 实现已添加状态显示
  - 添加响应式布局
  - _需求: 1.7, 2.1, 2.4, 6.2, 6.3_

- [ ]* 5.1 编写属性测试：UI状态更新
  - **属性 4: 搜索结果正确标记已添加联系人** (需求: 1.7)
  - **属性 7: 添加联系人更新UI状态** (需求: 2.4)

- [x] 6. 实现搜索结果列表组件
  - 创建 `src/components/contacts/SearchResults.tsx`
  - 显示搜索结果列表
  - 实现空状态提示
  - 集成UserCard组件
  - 处理加载和错误状态
  - _需求: 1.1-1.7, 6.2, 6.6_

- [x] 7. 实现联系人卡片组件
  - 创建 `src/components/contacts/ContactCard.tsx`
  - 显示联系人头像和用户名
  - 实现删除联系人按钮
  - 实现删除确认对话框
  - 添加WhatsApp风格样式
  - _需求: 3.3, 4.1, 4.2, 6.2, 6.3_

- [ ]* 7.1 编写属性测试：删除后状态更新
  - **属性 13: 删除后状态更新** (需求: 4.4)

- [x] 8. 实现联系人列表组件
  - 创建 `src/components/contacts/ContactList.tsx`
  - 显示所有联系人
  - 实现空状态提示
  - 集成ContactCard组件
  - 实现加载状态
  - _需求: 3.1-3.5, 6.2, 6.6_

- [x] 9. 实现联系人页面主组件
  - 创建 `src/components/contacts/ContactsPage.tsx`
  - 集成SearchBar、SearchResults和ContactList组件
  - 实现状态管理（搜索查询、搜索结果、联系人列表）
  - 实现添加联系人逻辑（含验证和错误处理）
  - 实现删除联系人逻辑（含确认和错误处理）
  - 实现Toast通知
  - _需求: 所有需求_

- [x] 10. 添加联系人页面路由
  - 更新 `src/App.tsx` 添加联系人页面路由
  - 添加导航菜单项
  - 实现页面切换
  - _需求: 所有需求的基础_

- [x] 11. 实现样式和响应式设计
  - 创建 `src/components/contacts/Contacts.css`
  - 实现WhatsApp风格的卡片设计
  - 实现响应式布局（移动端和桌面端）
  - 添加交互动画和过渡效果
  - 优化移动端触摸体验
  - _需求: 6.1-6.6_

- [x] 12. 检查点 - 验证核心功能
  - 确保所有核心功能正常工作
  - 运行已有的属性测试
  - 测试搜索、添加、删除流程
  - 验证授权隔离
  - 如有问题请询问用户

- [ ]* 13. 性能优化
  - 实现搜索结果缓存
  - 实现联系人列表缓存
  - 添加React.memo优化渲染
  - 实现图片懒加载
  - 优化防抖参数
  - _需求: 7.1_

- [ ]* 14. 编写集成测试
  - 测试完整搜索流程（输入→防抖→请求→显示）
  - 测试完整添加流程（搜索→添加→更新UI→Toast）
  - 测试完整删除流程（列表→删除→确认→更新）
  - 测试多用户场景下的数据隔离
  - _需求: 所有需求_

- [ ]* 15. 编写E2E测试
  - 配置Cypress或Playwright
  - 测试用户搜索和添加联系人流程
  - 测试用户查看和删除联系人流程
  - 测试响应式布局
  - _需求: 所有需求_

- [ ]* 16. 部署到生产环境
  - 部署到staging环境测试
  - 进行用户验收测试
  - 配置CloudWatch监控和告警
  - 部署到生产环境
  - _需求: 所有需求_

- [ ]* 17. 编写文档
  - 更新README.md添加联系人功能说明
  - 编写组件使用文档
  - 更新API文档
  - _需求: 所有需求_

- [ ]* 18. 最终验证
  - 验证生产环境功能
  - 确保所有测试通过
  - 检查性能指标
  - 如有问题请询问用户


## 任务说明

### 可选任务标记
带有 `*` 后缀的任务为可选任务，主要包括测试、性能优化、部署和文档相关的任务。这些任务对于确保代码质量很重要，但不是核心功能实现的必需部分。

### 属性测试要求
- 使用 `fast-check` 库
- 每个属性测试至少运行100次迭代
- 必须使用注释标记对应的设计文档属性：`// **Feature: contact-management, Property X: 属性名称**`

### 实施顺序
1. 首先完成后端扩展和部署（任务1-2）
2. 然后实现API工具函数和测试（任务3）
3. 接着实现UI组件（任务4-8）
4. 集成所有组件（任务9-10）
5. 完善样式和体验（任务11）
6. 验证和优化（任务12-13）
7. 最后进行测试、部署和文档（任务14-18）

### 依赖关系
- 任务3-18依赖任务1-2完成（后端扩展）
- 任务4-8可以并行开发（各个组件独立）
- 任务9依赖任务3-8完成（集成所有组件）
- 任务10依赖任务9完成（页面路由）
- 任务12是检查点，确保核心功能正常
- 任务13-18是可选的优化和完善任务

### 测试策略
- 单元测试：验证工具函数和边界情况
- 属性测试：验证通用正确性属性（17个属性）
- 集成测试：验证多组件交互
- E2E测试：验证完整用户流程

### 增量开发
这是对现有系统的扩展，采用增量开发策略：
1. 后端扩展不影响现有功能
2. 前端组件独立开发和测试
3. 可以逐步集成到主应用
4. 支持独立部署和回滚

### 性能目标
- 搜索响应时间 < 500ms
- 添加联系人延迟 < 300ms
- 联系人列表加载 < 400ms
- 删除联系人延迟 < 300ms
