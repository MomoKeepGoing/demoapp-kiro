# 端到端测试执行说明

## 测试准备完成状态

✅ **后端验证已完成**
- GraphQL API 端点已配置并可访问
- DynamoDB 表已创建（Message, Conversation, UserProfile, Contact）
- GSI 索引已正确配置（bySender, byReceiver, byConversation, byUser）
- 授权规则已配置并验证

✅ **测试文档已准备**
- 详细测试指南: `docs/E2E-MESSAGING-TEST-GUIDE.md`
- 部署验证报告: `docs/MESSAGING-DEPLOYMENT-VERIFICATION.md`
- 验证脚本: `scripts/verify-messaging.ts`

## 如何执行端到端测试

### 步骤 1: 启动测试环境

**终端 1 - 启动 Amplify Sandbox**:
```bash
npx ampx sandbox
```
等待输出显示 "Watching for file changes..."

**终端 2 - 启动前端开发服务器**:
```bash
npm run dev
```
访问 http://localhost:5173

### 步骤 2: 准备测试账号

需要创建至少 3 个测试账号：
- **用户 A**: 主要测试用户
- **用户 B**: 用户 A 的联系人
- **用户 C**: 非联系人用户

在浏览器中注册并验证这些账号。

### 步骤 3: 执行测试用例

按照 `docs/E2E-MESSAGING-TEST-GUIDE.md` 中的 14 个测试用例逐一执行：

1. ✅ 用户 A 发送消息给用户 B
2. ✅ 用户 B 实时接收消息
3. ✅ 用户 B 查看消息并自动标记已读
4. ✅ 离线消息处理
5. ✅ 未读消息数量显示
6. ✅ 标记已读功能
7. ✅ 非联系人消息
8. ✅ 消息历史分页加载
9. ✅ 对话列表排序
10. ✅ 错误处理 - 网络断开
11. ✅ 错误处理 - Subscription 重连
12. ✅ 消息输入体验
13. ✅ 时间格式化
14. ✅ 授权规则

### 步骤 4: 记录测试结果

在 `docs/E2E-MESSAGING-TEST-GUIDE.md` 的"测试结果记录"部分填写：
- 测试环境信息
- 每个测试用例的通过/失败状态
- 发现的问题（如有）
- 测试结论

## 测试重点

### 核心功能测试
- **消息发送和接收**: 验证基本的消息传输功能
- **实时更新**: 验证 WebSocket subscription 工作正常
- **离线消息**: 验证消息持久化和离线同步

### 数据一致性测试
- **未读数量**: 验证未读计数准确
- **对话排序**: 验证对话列表按时间排序
- **消息排序**: 验证消息历史按时间排序

### 安全性测试
- **授权规则**: 验证用户只能访问自己的数据
- **非联系人消息**: 验证跨联系人状态的消息传输

### 用户体验测试
- **错误处理**: 验证网络错误的友好提示
- **重连机制**: 验证断线重连功能
- **输入体验**: 验证键盘快捷键和输入框行为

## 快速验证命令

### 验证后端配置
```bash
npx tsx scripts/verify-messaging.ts
```

### 运行单元测试
```bash
npm test -- --run
```

### 检查代码质量
```bash
npm run lint
```

## 测试环境要求

- **Node.js**: v18 或更高版本
- **浏览器**: Chrome, Firefox, Safari（最新版本）
- **网络**: 稳定的互联网连接
- **AWS 账号**: 已配置 Amplify 项目

## 常见问题

### Q: Amplify sandbox 启动失败
A: 检查 AWS 凭证配置，确保有足够的权限

### Q: 前端无法连接到后端
A: 确保 `amplify_outputs.json` 文件存在且配置正确

### Q: 消息发送失败
A: 检查用户是否已登录，网络连接是否正常

### Q: 实时消息不更新
A: 检查 WebSocket 连接状态，尝试刷新页面

## 测试完成标准

✅ 所有 14 个测试用例通过  
✅ 未发现严重或中等级别的 bug  
✅ 用户体验流畅，无明显性能问题  
✅ 错误处理友好，提示信息清晰  

## 下一步

测试完成后：
1. 整理测试报告
2. 修复发现的问题（如有）
3. 进行回归测试
4. 准备生产环境部署

---

**注意**: 这是一个手动测试过程，需要人工执行。自动化测试（单元测试和属性测试）已在之前的任务中完成。

**测试时间估计**: 2-3 小时（取决于测试的详细程度）

**建议**: 
- 使用多个浏览器窗口或设备进行测试
- 记录测试过程的截图或视频
- 详细记录任何异常行为
- 测试完成后清理测试数据
