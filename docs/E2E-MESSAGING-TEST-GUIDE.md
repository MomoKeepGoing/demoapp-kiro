# 消息系统端到端测试指南

## 测试环境准备

### 前置条件
- ✅ Amplify sandbox 已部署（验证通过）
- ✅ GraphQL API 端点已配置
- ✅ DynamoDB 表已创建（Message, Conversation）
- ✅ GSI 索引已配置（bySender, byReceiver, byConversation, byUser）
- ✅ 授权规则已配置

### 启动测试环境

1. **启动 Amplify Sandbox**（如果未运行）
   ```bash
   npx ampx sandbox
   ```
   等待输出显示 "Watching for file changes..."

2. **启动前端开发服务器**（新终端窗口）
   ```bash
   npm run dev
   ```
   访问 http://localhost:5173

## 测试账号准备

为了进行完整的端到端测试，需要准备至少 3 个测试账号：

- **用户 A**: 主要测试用户
- **用户 B**: 用户 A 的联系人
- **用户 C**: 非联系人用户

### 创建测试账号步骤

1. 在浏览器中打开应用
2. 点击"创建账号"
3. 填写邮箱和密码
4. 验证邮箱（检查邮箱中的验证码）
5. 设置用户名和头像
6. 重复以上步骤创建 3 个账号

## 测试用例清单

### ✅ 测试 1: 用户 A 发送消息给用户 B

**前置条件**: 用户 A 和用户 B 已互相添加为联系人

**测试步骤**:
1. 使用用户 A 登录
2. 进入"消息"页面
3. 点击用户 B 的对话（如果不存在，从联系人页面发起对话）
4. 在输入框输入测试消息："你好，这是测试消息 1"
5. 点击发送按钮或按 Enter 键

**预期结果**:
- ✅ 消息立即显示在对话界面（乐观更新）
- ✅ 消息状态从"发送中"变为"已发送"
- ✅ 消息显示在右侧（发送者样式）
- ✅ 消息显示时间戳
- ✅ 输入框被清空
- ✅ 对话列表中该对话的最后消息更新

**验证点**:
- [ ] 消息内容正确
- [ ] 消息状态正确
- [ ] 时间戳显示正确
- [ ] UI 样式正确

---

### ✅ 测试 2: 用户 B 实时接收消息

**前置条件**: 用户 B 已登录并在线

**测试步骤**:
1. 在另一个浏览器窗口（或隐身模式）使用用户 B 登录
2. 进入"消息"页面
3. 保持在对话列表页面
4. 使用用户 A 发送消息："实时消息测试"

**预期结果**:
- ✅ 用户 B 的对话列表实时更新
- ✅ 与用户 A 的对话移到列表顶部
- ✅ 显示未读消息数量标记（红点）
- ✅ 最后消息预览更新为新消息内容
- ✅ 最后消息时间更新

**验证点**:
- [ ] 对话列表实时更新
- [ ] 未读标记显示
- [ ] 对话排序正确（最新对话在顶部）

---

### ✅ 测试 3: 用户 B 查看消息并自动标记已读

**前置条件**: 用户 B 收到用户 A 的未读消息

**测试步骤**:
1. 用户 B 点击与用户 A 的对话
2. 查看对话界面

**预期结果**:
- ✅ 所有消息按时间顺序显示（旧到新）
- ✅ 用户 A 的消息显示在左侧（接收者样式）
- ✅ 自动滚动到最新消息
- ✅ 未读消息数量标记消失
- ✅ 对话列表中的未读数量清零

**验证点**:
- [ ] 消息历史完整显示
- [ ] 消息排序正确
- [ ] 自动标记已读
- [ ] 未读标记清除

---

### ✅ 测试 4: 离线消息处理

**前置条件**: 用户 B 离线

**测试步骤**:
1. 用户 B 退出登录或关闭浏览器
2. 用户 A 发送多条消息：
   - "离线消息 1"
   - "离线消息 2"
   - "离线消息 3"
3. 等待 5 秒确保消息已保存
4. 用户 B 重新登录
5. 进入"消息"页面

**预期结果**:
- ✅ 对话列表显示与用户 A 的对话
- ✅ 显示未读消息数量（3）
- ✅ 最后消息预览显示"离线消息 3"
- ✅ 点击对话后，所有 3 条离线消息都显示
- ✅ 消息按时间顺序排列
- ✅ 查看后自动标记为已读

**验证点**:
- [ ] 离线消息成功存储
- [ ] 上线后正确加载
- [ ] 未读数量正确
- [ ] 查看后标记已读

---

### ✅ 测试 5: 未读消息数量显示

**前置条件**: 用户 B 有多个对话，部分有未读消息

**测试步骤**:
1. 用户 A 发送消息给用户 B
2. 用户 C 发送消息给用户 B
3. 用户 B 登录并查看消息页面

**预期结果**:
- ✅ 每个对话显示各自的未读数量
- ✅ 应用标题栏显示总未读数量
- ✅ 未读数量用红色圆点或数字标记
- ✅ 查看某个对话后，该对话的未读数量清零
- ✅ 总未读数量相应减少

**验证点**:
- [ ] 各对话未读数量正确
- [ ] 总未读数量正确
- [ ] 查看后正确更新

---

### ✅ 测试 6: 标记已读功能

**前置条件**: 用户 B 有未读消息

**测试步骤**:
1. 用户 B 打开有未读消息的对话
2. 滚动查看所有消息
3. 返回对话列表

**预期结果**:
- ✅ 打开对话时，所有未读消息自动标记为已读
- ✅ 对话列表中该对话的未读标记消失
- ✅ 总未读数量减少
- ✅ 再次打开该对话，不再显示未读标记

**验证点**:
- [ ] 批量标记已读成功
- [ ] UI 状态正确更新
- [ ] 数据持久化正确

---

### ✅ 测试 7: 非联系人消息

**前置条件**: 用户 C 不是用户 A 的联系人

**测试步骤**:
1. 用户 C 登录
2. 在联系人搜索中找到用户 A
3. 点击用户 A 的用户卡片
4. 发送消息："你好，我是用户 C"
5. 用户 A 登录并查看消息

**预期结果**:
- ✅ 用户 C 可以成功发送消息给用户 A
- ✅ 用户 A 收到来自用户 C 的消息
- ✅ 对话列表中显示用户 C 的对话
- ✅ 对话中显示"添加为联系人"按钮
- ✅ 点击按钮后，用户 C 被添加为联系人
- ✅ "添加为联系人"按钮消失

**验证点**:
- [ ] 非联系人可以发送消息
- [ ] 非联系人可以接收消息
- [ ] 非联系人标记显示
- [ ] 添加联系人功能正常

---

### ✅ 测试 8: 消息历史分页加载

**前置条件**: 用户 A 和用户 B 之间有超过 50 条消息

**测试步骤**:
1. 用户 A 发送 60 条测试消息给用户 B
2. 用户 B 打开与用户 A 的对话
3. 滚动到对话顶部

**预期结果**:
- ✅ 初始加载显示最近 50 条消息
- ✅ 滚动到顶部时自动加载更早的消息
- ✅ 显示加载指示器
- ✅ 加载完成后，更早的消息显示在顶部
- ✅ 滚动位置保持在加载前的位置

**验证点**:
- [ ] 分页加载正常
- [ ] 加载指示器显示
- [ ] 滚动位置正确
- [ ] 消息顺序正确

---

### ✅ 测试 9: 对话列表排序

**前置条件**: 用户 A 有多个对话

**测试步骤**:
1. 用户 A 与用户 B、用户 C 都有对话
2. 用户 B 发送消息给用户 A
3. 等待 5 秒
4. 用户 C 发送消息给用户 A
5. 用户 A 查看对话列表

**预期结果**:
- ✅ 对话按最后消息时间倒序排列
- ✅ 用户 C 的对话在最顶部
- ✅ 用户 B 的对话在下方
- ✅ 发送新消息后，对话自动移到顶部

**验证点**:
- [ ] 对话排序正确
- [ ] 实时更新排序
- [ ] 最新对话在顶部

---

### ✅ 测试 10: 错误处理 - 网络断开

**测试步骤**:
1. 用户 A 打开对话
2. 在浏览器开发者工具中模拟离线（Network -> Offline）
3. 尝试发送消息："网络测试"
4. 恢复网络连接

**预期结果**:
- ✅ 发送失败时显示错误提示
- ✅ 消息状态显示为"失败"
- ✅ 显示重试按钮
- ✅ 点击重试后，消息成功发送
- ✅ Toast 提示显示友好的错误信息

**验证点**:
- [ ] 错误提示显示
- [ ] 失败状态正确
- [ ] 重试功能正常
- [ ] 用户体验友好

---

### ✅ 测试 11: 错误处理 - Subscription 重连

**测试步骤**:
1. 用户 A 和用户 B 都在线
2. 模拟网络中断（关闭 WiFi 5 秒后重新连接）
3. 用户 B 发送消息给用户 A

**预期结果**:
- ✅ 网络中断时显示"正在重新连接..."
- ✅ 网络恢复后自动重连
- ✅ 重连成功后，用户 A 收到离线期间的消息
- ✅ 不需要刷新页面

**验证点**:
- [ ] 重连机制正常
- [ ] 离线消息同步
- [ ] 用户体验流畅

---

### ✅ 测试 12: 消息输入体验

**测试步骤**:
1. 用户 A 打开对话
2. 在输入框输入单行文本，按 Enter 发送
3. 输入多行文本（按 Shift+Enter 换行）
4. 输入超过 4 行的文本
5. 输入空白字符（只有空格）

**预期结果**:
- ✅ Enter 键发送消息
- ✅ Shift+Enter 插入换行符
- ✅ 输入框高度自动调整（最多 4 行）
- ✅ 超过 4 行时启用滚动
- ✅ 空白字符无法发送
- ✅ 发送后输入框重置为初始高度

**验证点**:
- [ ] 键盘快捷键正常
- [ ] 输入框自动调整
- [ ] 内容验证正常

---

### ✅ 测试 13: 时间格式化

**测试步骤**:
1. 发送消息并查看时间显示
2. 等待到第二天，查看昨天的消息
3. 查看更早的消息

**预期结果**:
- ✅ 今天的消息只显示时间（如"14:30"）
- ✅ 昨天的消息显示"昨天 14:30"
- ✅ 更早的消息显示完整日期（如"2024-12-01 14:30"）
- ✅ 连续消息（5分钟内）只在第一条显示时间

**验证点**:
- [ ] 时间格式正确
- [ ] 时间戳显示逻辑正确

---

### ✅ 测试 14: 授权规则

**测试步骤**:
1. 用户 A 和用户 B 有对话
2. 用户 C 尝试通过直接 URL 访问用户 A 和用户 B 的对话
3. 用户 C 尝试通过 GraphQL API 查询用户 A 的消息

**预期结果**:
- ✅ 用户 C 无法访问其他用户的对话
- ✅ 显示授权错误提示
- ✅ 自动返回到对话列表
- ✅ GraphQL API 返回授权错误

**验证点**:
- [ ] 授权规则生效
- [ ] 错误处理正确
- [ ] 数据安全

---

## 测试结果记录

### 测试环境信息
- 测试日期: ___________
- Amplify Sandbox 版本: ___________
- 浏览器: ___________
- 测试人员: ___________

### 测试结果汇总

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 1. 发送消息 | ⬜ 通过 / ⬜ 失败 | |
| 2. 实时接收 | ⬜ 通过 / ⬜ 失败 | |
| 3. 自动已读 | ⬜ 通过 / ⬜ 失败 | |
| 4. 离线消息 | ⬜ 通过 / ⬜ 失败 | |
| 5. 未读数量 | ⬜ 通过 / ⬜ 失败 | |
| 6. 标记已读 | ⬜ 通过 / ⬜ 失败 | |
| 7. 非联系人 | ⬜ 通过 / ⬜ 失败 | |
| 8. 分页加载 | ⬜ 通过 / ⬜ 失败 | |
| 9. 对话排序 | ⬜ 通过 / ⬜ 失败 | |
| 10. 网络错误 | ⬜ 通过 / ⬜ 失败 | |
| 11. 重连机制 | ⬜ 通过 / ⬜ 失败 | |
| 12. 输入体验 | ⬜ 通过 / ⬜ 失败 | |
| 13. 时间格式 | ⬜ 通过 / ⬜ 失败 | |
| 14. 授权规则 | ⬜ 通过 / ⬜ 失败 | |

### 发现的问题

1. **问题描述**: ___________
   - 严重程度: ⬜ 高 / ⬜ 中 / ⬜ 低
   - 复现步骤: ___________
   - 预期结果: ___________
   - 实际结果: ___________

2. **问题描述**: ___________
   - 严重程度: ⬜ 高 / ⬜ 中 / ⬜ 低
   - 复现步骤: ___________
   - 预期结果: ___________
   - 实际结果: ___________

### 测试结论

⬜ 所有测试通过，可以进入下一阶段
⬜ 存在问题，需要修复后重新测试

---

## 快速测试命令

### 验证后端配置
```bash
# 运行消息系统后端验证脚本
npx tsx scripts/verify-messaging.ts

# 预期输出: 13/13 测试通过
# 验证内容:
# - GraphQL API 端点
# - DynamoDB 表（Message, Conversation, UserProfile, Contact）
# - 数据模型字段完整性
# - GSI 索引配置
# - 授权规则配置
```

### 启动测试环境
```bash
# 终端 1: Amplify Sandbox
npx ampx sandbox

# 终端 2: 前端开发服务器
npm run dev
```

### 运行单元测试
```bash
npm test
```

### 运行属性测试
```bash
npm test -- --run
```

---

## 注意事项

1. **测试数据清理**: 测试完成后，建议清理测试数据或使用新的测试账号
2. **浏览器缓存**: 如果遇到问题，尝试清除浏览器缓存
3. **网络环境**: 确保网络连接稳定，避免误判网络错误测试
4. **时区设置**: 时间格式化测试需要考虑本地时区
5. **并发测试**: 实时消息测试需要使用多个浏览器窗口或设备

---

## 附录: 常见问题排查

### 问题 1: 消息发送失败
- 检查 Amplify sandbox 是否正在运行
- 检查网络连接
- 查看浏览器控制台错误信息
- 验证用户认证状态

### 问题 2: 实时消息不更新
- 检查 WebSocket 连接状态
- 验证 subscription 是否正确订阅
- 查看网络面板的 WebSocket 消息
- 尝试刷新页面重新建立连接

### 问题 3: 未读数量不正确
- 检查 markConversationAsRead 函数是否正确执行
- 验证 DynamoDB 中的 isRead 字段
- 查看 unreadCount 计算逻辑
- 检查是否有并发更新冲突

### 问题 4: 授权错误
- 验证用户是否已登录
- 检查 Cognito 用户池配置
- 查看 GraphQL API 授权规则
- 确认 owner 字段配置正确
